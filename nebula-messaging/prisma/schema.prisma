generator client {
  provider        = "prisma-client-js"
  output          = "../generated/prisma"
  previewFeatures = ["relationJoins"]
}

datasource db {
  provider = "postgresql"
}

model User {
  id                       String                    @id @default(cuid())
  googleId                 String?                   @unique @map("google_id")
  email                    String                    @unique
  hashedPassword           String?                   @map("hashed_password")
  role                     UserRole                  @default(STUDENT)
  status                   UserStatus                @default(PENDING)
  fullName                 String?                   @map("full_name")
  avatarUrl                String?                   @map("avatar_url")
  emailVerified            DateTime?                 @map("email_verified")
  verificationToken        String?                   @unique @map("verification_token")
  verificationTokenExpires DateTime?                 @map("verification_token_expires")
  resetToken               String?                   @unique @map("reset_token")
  resetTokenExpires        DateTime?                 @map("reset_token_expires")
  createdAt                DateTime                  @default(now()) @map("created_at")
  updatedAt                DateTime                  @updatedAt @map("updated_at")
  stripeCustomerId         String?                   @map("stripe_customer_id")
  coachReviews             CoachReview[]
  coach                    Coach?
  conversations            ConversationParticipant[]
  organizedEvents          Event[]                   @relation("EventOrganizer")
  messagesSent             Message[]
  programReviews           ProgramReview[]
  student                  Student?

  @@index([role, status])
  @@index([createdAt])
  @@map("users")
}

model Category {
  id                 String          @id @default(cuid())
  name               String          @unique
  slug               String          @unique
  isActive           Boolean         @default(true) @map("is_active")
  createdAt          DateTime        @default(now()) @map("created_at")
  updatedAt          DateTime        @updatedAt @map("updated_at")
  coachCategories    CoachCategory[]
  programs           Program[]
  interestedStudents Student[]

  @@index([isActive])
  @@map("categories")
}

model Coach {
  id                         String          @id @default(cuid())
  userId                     String          @unique @map("user_id")
  title                      String
  bio                        String
  style                      String
  pastCompanies              String[]        @map("past_companies")
  linkedinUrl                String?         @map("linkedin_url")
  availability               String
  hourlyRate                 Int             @map("hourly_rate")
  isActive                   Boolean         @default(true) @map("is_active")
  isVerified                 Boolean         @default(false) @map("is_verified")
  slug                       String?         @unique
  qualifications             String[]
  experience                 String?
  timezone                   String?
  languages                  String[]
  googleCalendarAccessToken  String?         @map("google_calendar_access_token")
  googleCalendarRefreshToken String?         @map("google_calendar_refresh_token")
  totalSessions              Int             @default(0) @map("total_sessions")
  rating                     Float           @default(0)
  totalReviews               Int             @default(0) @map("total_reviews")
  studentsCoached            Int             @default(0) @map("students_coached")
  createdAt                  DateTime        @default(now()) @map("created_at")
  updatedAt                  DateTime        @updatedAt @map("updated_at")
  specialties                CoachCategory[]
  reviews                    CoachReview[]
  user                       User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  enrollments                Enrollment[]
  coachPrograms              ProgramCoach[]
  programs                   Program[]
  sessions                   Session[]

  @@index([isActive, isVerified])
  @@index([createdAt])
  @@index([rating])
  @@map("coaches")
}

model Session {
  id              String              @id @default(cuid())
  coachId         String              @map("coach_id")
  title           String?
  description     String?
  scheduledTime   DateTime            @map("scheduled_time")
  duration        Int
  status          SessionStatus       @default(SCHEDULED)
  meetLink        String?             @map("meet_link")
  googleEventId   String?             @map("google_event_id")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")
  paymentStatus   PaymentStatus       @default(PENDING) @map("payment_status")
  price           Int                 @default(0)
  stripeSessionId String?             @map("stripe_session_id")
  notes           String?
  attendance      SessionAttendance[]
  coach           Coach               @relation(fields: [coachId], references: [id])

  @@index([coachId])
  @@index([scheduledTime])
  @@index([status])
  @@index([coachId, scheduledTime])
  @@index([coachId, status])
  @@map("sessions")
}

model SessionAttendance {
  id        String  @id @default(cuid())
  sessionId String  @map("session_id")
  studentId String  @map("student_id")
  attended  Boolean @default(false)
  session   Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([sessionId, studentId])
  @@index([sessionId])
  @@index([studentId])
  @@map("session_attendance")
}

model CoachCategory {
  id         String   @id @default(cuid())
  coachId    String   @map("coach_id")
  categoryId String   @map("category_id")
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  coach      Coach    @relation(fields: [coachId], references: [id], onDelete: Cascade)

  @@unique([coachId, categoryId])
  @@index([categoryId])
  @@map("coach_categories")
}

model Student {
  id                   String              @id @default(cuid())
  userId               String              @unique @map("user_id")
  interestedCategoryId String?             @map("interested_category_id")
  skillLevel           ExperienceLevel?
  commitment           String?
  learningGoals        String[]            @map("learning_goals")
  currentLevel         String?             @map("current_level")
  timeZone             String?             @map("time_zone")
  createdAt            DateTime            @default(now()) @map("created_at")
  updatedAt            DateTime            @updatedAt @map("updated_at")
  enrollments          Enrollment[]
  eventAttendances     EventAttendee[]
  sessions             SessionAttendance[]
  preferences          StudentPreferences?
  interestedCategory   Category?           @relation(fields: [interestedCategoryId], references: [id])
  user                 User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([interestedCategoryId])
  @@index([skillLevel])
  @@map("students")
}

model StudentPreferences {
  id                   String  @id @default(cuid())
  studentId            String  @unique @map("student_id")
  timezone             String
  notifications        Boolean @default(true)
  emailUpdates         Boolean @default(true) @map("email_updates")
  preferredContactTime String? @map("preferred_contact_time")
  communicationStyle   String? @map("communication_style")
  student              Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("student_preferences")
}

model ProgramReview {
  id        String   @id @default(cuid())
  rating    Int
  comment   String?
  programId String
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  program   Program  @relation(fields: [programId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([programId, userId])
  @@map("program_reviews")
}

model CoachReview {
  id        String   @id @default(cuid())
  rating    Int
  comment   String?
  coachId   String
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  coach     Coach    @relation(fields: [coachId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([coachId, userId])
  @@map("coach_reviews")
}

model Program {
  id                 String            @id @default(cuid())
  title              String
  categoryId         String            @map("category_id")
  description        String
  objectives         String[]
  coachId            String            @map("coach_id")
  slug               String            @unique
  price              Int               @default(0)
  duration           String?
  difficultyLevel    ExperienceLevel   @default(BEGINNER)
  maxStudents        Int               @default(100)
  currentEnrollments Int               @default(0) @map("current_enrollments")
  isActive           Boolean           @default(false)
  status             ProgramStatus     @default(INACTIVE)
  rating             Float             @default(0)
  totalReviews       Int               @default(0) @map("total_reviews")
  tags               String[]
  prerequisites      String[]
  targetAudience     ExperienceLevel[]
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  enrollments        Enrollment[]
  modules            Module[]
  coCoaches          ProgramCoach[]
  cohorts            Cohort[]
  reviews            ProgramReview[]
  category           Category          @relation(fields: [categoryId], references: [id])
  coach              Coach             @relation(fields: [coachId], references: [id])

  @@index([categoryId])
  @@index([coachId])
  @@index([isActive, status])
  @@index([difficultyLevel])
  @@map("programs")
}

model Cohort {
  id          String       @id @default(cuid())
  programId   String       @map("program_id")
  name        String?
  startDate   DateTime     @map("start_date")
  endDate     DateTime?    @map("end_date")
  maxStudents Int          @default(100) @map("max_students")
  status      CohortStatus @default(UPCOMING)
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  enrollments Enrollment[]
  program     Program      @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@index([programId])
  @@index([status])
  @@map("program_cohorts")
}

model ProgramCoach {
  id        String   @id @default(cuid())
  programId String
  coachId   String
  createdAt DateTime @default(now())
  coach     Coach    @relation(fields: [coachId], references: [id], onDelete: Cascade)
  program   Program  @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([programId, coachId])
  @@map("program_coaches")
}

model Module {
  id          String     @id @default(cuid())
  programId   String
  title       String
  week        Int
  description String?
  materials   Material[]
  program     Program    @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([programId, week])
  @@index([programId])
  @@map("modules")
}

model Material {
  id        String   @id @default(cuid())
  moduleId  String   @map("module_id")
  fileName  String   @map("file_name")
  url       String
  mimeType  String   @map("mime_type")
  position  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  module    Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@index([moduleId])
  @@index([moduleId, position])
  @@map("materials")
}

model Enrollment {
  id              String           @id @default(cuid())
  studentId       String
  programId       String
  cohortId        String?
  coachId         String
  status          EnrollmentStatus @default(ACTIVE)
  enrollmentDate  DateTime         @default(now())
  completionDate  DateTime?
  progress        Float            @default(0)
  paymentStatus   PaymentStatus    @default(PENDING)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  stripeSessionId String?          @map("stripe_session_id")
  coach           Coach            @relation(fields: [coachId], references: [id])
  cohort          Cohort?          @relation(fields: [cohortId], references: [id])
  program         Program          @relation(fields: [programId], references: [id], onDelete: Cascade)
  student         Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, programId])
  @@index([studentId])
  @@index([programId])
  @@index([coachId, status])
  @@map("enrollments")
}

model Conversation {
  id              String                    @id @default(cuid())
  type            ConversationType          @default(DIRECT)
  title           String?
  lastMessage     String?                   @map("last_message")
  lastMessageTime DateTime?                 @map("last_message_time")
  isActive        Boolean                   @default(true) @map("is_active")
  isArchived      Boolean                   @default(false) @map("is_archived")
  createdAt       DateTime                  @default(now()) @map("created_at")
  updatedAt       DateTime                  @updatedAt @map("updated_at")
  participants    ConversationParticipant[]
  messages        Message[]

  @@index([createdAt])
  @@index([lastMessageTime])
  @@index([type])
  @@map("conversations")
}

model ConversationParticipant {
  id             String       @id @default(cuid())
  conversationId String       @map("conversation_id")
  userId         String       @map("user_id")
  unreadCount    Int          @default(0) @map("unread_count")
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
  @@index([conversationId])
  @@map("conversation_participants")
}

model Message {
  id             String              @id @default(cuid())
  conversationId String              @map("conversation_id")
  senderId       String              @map("sender_id")
  content        String
  type           MessageType         @default(TEXT)
  isRead         Boolean             @default(false) @map("is_read")
  readAt         DateTime?           @map("read_at")
  editedAt       DateTime?           @map("edited_at")
  isEdited       Boolean             @default(false) @map("is_edited")
  isDeleted      Boolean             @default(false) @map("is_deleted")
  createdAt      DateTime            @default(now()) @map("created_at")
  updatedAt      DateTime            @updatedAt @map("updated_at")
  attachments    MessageAttachment[]
  reactions      MessageReaction[]
  conversation   Conversation        @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User                @relation(fields: [senderId], references: [id])

  @@index([conversationId, createdAt])
  @@index([conversationId, isRead])
  @@index([senderId])
  @@map("messages")
}

model MessageAttachment {
  id         String   @id @default(cuid())
  messageId  String   @map("message_id")
  fileName   String   @map("file_name")
  fileUrl    String   @map("file_url")
  fileSize   Int      @map("file_size")
  mimeType   String   @map("mime_type")
  uploadedAt DateTime @default(now()) @map("uploaded_at")
  message    Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@map("message_attachments")
}

model MessageReaction {
  id        String   @id @default(cuid())
  messageId String   @map("message_id")
  userId    String   @map("user_id")
  emoji     String
  createdAt DateTime @default(now()) @map("created_at")
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@index([userId])
  @@map("message_reactions")
}

model Event {
  id             String          @id @default(cuid())
  title          String
  description    String
  eventType      String          @map("event_type")
  date           DateTime
  location       String?
  images         String[]
  slug           String          @unique
  organizerId    String          @map("organizer_id")
  isPublic       Boolean         @default(true) @map("is_public")
  maxAttendees   Int?            @map("max_attendees")
  status         String?
  tags           String[]
  meetLink       String?         @map("meet_link")
  googleEventId  String?         @map("google_event_id")
  whatToBring    String?         @map("what_to_bring")
  additionalInfo String?         @map("additional_info")
  lumaEventLink  String          @map("luma_event_link")
  accessType     String?         @map("access_type")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  price          Int             @default(0)
  attendees      EventAttendee[]
  organizer      User            @relation("EventOrganizer", fields: [organizerId], references: [id])

  @@index([slug])
  @@index([organizerId])
  @@index([date])
  @@index([eventType])
  @@index([isPublic, date])
  @@index([status])
  @@map("events")
}

model EventAttendee {
  id              String              @id @default(cuid())
  eventId         String              @map("event_id")
  studentId       String              @map("student_id")
  status          EventAttendeeStatus @default(REGISTERED)
  registeredAt    DateTime            @default(now()) @map("registered_at")
  attendedAt      DateTime?           @map("attended_at")
  cancelledAt     DateTime?           @map("cancelled_at")
  notes           String?
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")
  paymentStatus   PaymentStatus       @default(PENDING) @map("payment_status")
  stripeSessionId String?             @map("stripe_session_id")
  event           Event               @relation(fields: [eventId], references: [id], onDelete: Cascade)
  student         Student             @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([eventId, studentId])
  @@index([eventId])
  @@index([studentId])
  @@index([status])
  @@map("event_attendees")
}

enum UserRole {
  STUDENT
  COACH
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING
}

enum ProgramStatus {
  PENDING_APPROVAL
  APPROVED
  SUBMITTED
  ACTIVE
  INACTIVE
  REJECTED
}

enum ExperienceLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  CANCELLED
  PAUSED
}

enum CohortStatus {
  UPCOMING
  ACTIVE
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum SessionStatus {
  REQUESTED
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  LINK
}

enum ConversationType {
  DIRECT
  GROUP
  SUPPORT
}

enum ReviewTargetType {
  PROGRAM
  COACH
  SESSION
}

enum EventAttendeeStatus {
  REGISTERED
  CONFIRMED
  ATTENDED
  CANCELLED
  NO_SHOW
}
