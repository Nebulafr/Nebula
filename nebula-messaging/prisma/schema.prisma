// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider        = "prisma-client-js"
  output          = "../generated/prisma"
  previewFeatures = ["relationJoins"]
}

datasource db {
  provider = "postgresql"
}

// Enums
enum UserRole {
  STUDENT
  COACH
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING
}

enum SkillLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum ProgramStatus {
  PENDING_APPROVAL
  APPROVED
  SUBMITTED
  ACTIVE
  INACTIVE
  REJECTED
}

enum DifficultyLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  CANCELLED
  PAUSED
}

enum CohortStatus {
  UPCOMING
  ACTIVE
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum SessionStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  LINK
}

enum ConversationType {
  DIRECT
  GROUP
  SUPPORT
}

enum ReviewTargetType {
  PROGRAM
  COACH
  SESSION
}

enum EventAttendeeStatus {
  REGISTERED
  CONFIRMED
  ATTENDED
  CANCELLED
  NO_SHOW
}

// Base model for timestamps
model User {
  id             String     @id @default(cuid())
  googleId       String?    @unique @map("google_id") // Google Auth ID (optional)
  email          String     @unique
  hashedPassword String?    @map("hashed_password") // For email auth (optional)
  role           UserRole   @default(STUDENT)
  status         UserStatus @default(PENDING)
  fullName       String?    @map("full_name")
  avatarUrl      String?    @map("avatar_url")
  emailVerified  DateTime?  @map("email_verified")
  verificationToken String? @unique @map("verification_token")
  verificationTokenExpires DateTime? @map("verification_token_expires")
  resetToken      String?    @unique @map("reset_token")
  resetTokenExpires DateTime? @map("reset_token_expires")
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")

  // Relationships
  coach   Coach?
  student Student?

  // Reviews given and received
  reviewsGiven    Review[] @relation("ReviewerUser")
  reviewsReceived Review[] @relation("RevieweeUser")

  // Messages sent
  messagesSent Message[]

  // Conversation participants
  conversations ConversationParticipant[]

  // Events organized
  organizedEvents Event[] @relation("EventOrganizer")

  // Indexes for performance
  @@index([email])
  @@index([role, status])
  @@index([createdAt])
  @@map("users")
}

model Category {
  id        String   @id @default(cuid())
  name      String   @unique
  slug      String   @unique
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relationships
  programs Program[]

  // Indexes for performance
  @@index([slug])
  @@index([isActive])
  @@map("categories")
}

model Coach {
  id                         String    @id @default(cuid())
  userId                     String    @unique @map("user_id")
  // Removed: email, fullName, avatarUrl (use user.email, user.fullName, user.avatarUrl instead)
  title                      String
  bio                        String    @db.Text
  style                      String
  specialties                String[]
  pastCompanies              String[]  @map("past_companies")
  linkedinUrl                String?   @map("linkedin_url")
  availability               String
  hourlyRate                 Int       @map("hourly_rate")
  rating                     Float?    @default(0)
  totalReviews               Int?      @default(0) @map("total_reviews")
  totalSessions              Int?      @default(0) @map("total_sessions")
  studentsCoached            Int?      @default(0) @map("students_coached")
  isActive                   Boolean   @default(true) @map("is_active")
  isVerified                 Boolean   @default(false) @map("is_verified")
  slug                       String?   @unique
  category                   String?
  qualifications             String[]
  experience                 String?
  timezone                   String?
  languages                  String[]
  googleCalendarAccessToken  String?   @map("google_calendar_access_token")
  googleCalendarRefreshToken String?   @map("google_calendar_refresh_token")
  googleCalendarConnectedAt  DateTime? @map("google_calendar_connected_at")
  createdAt                  DateTime  @default(now()) @map("created_at")
  updatedAt                  DateTime  @updatedAt @map("updated_at")

  // Relationships
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  programs      Program[]
  sessions      Session[]
  enrollments   Enrollment[]
  reviews       Review[]       @relation("ReviewCoach")
  coachPrograms ProgramCoach[]

  // Indexes for performance
  @@index([slug])
  @@index([isActive, isVerified])
  @@index([rating])
  @@index([category])
  @@index([createdAt])
  @@map("coaches")
}

model Student {
  id                String      @id @default(cuid())
  userId            String      @unique @map("user_id")
  // Removed: email, fullName, avatarUrl (use user.email, user.fullName, user.avatarUrl instead)
  interestedProgram String?     @map("interested_program")
  skillLevel        SkillLevel? @map("skill_level")
  commitment        String?
  learningGoals     String[]    @map("learning_goals")
  currentLevel      String?     @map("current_level")
  timeZone          String?     @map("time_zone")
  // Removed: enrolledPrograms, completedSessions, upcomingSessions (use relations instead for data integrity)
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  // Relationships
  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  enrollments Enrollment[]
  sessions    SessionAttendance[]
  preferences StudentPreferences?

  // Event attendance
  eventAttendances EventAttendee[]

  // Indexes for performance
  @@index([skillLevel])
  @@index([createdAt])
  @@map("students")
}

model StudentPreferences {
  id                   String  @id @default(cuid())
  studentId            String  @unique @map("student_id")
  timezone             String
  notifications        Boolean @default(true)
  emailUpdates         Boolean @default(true) @map("email_updates")
  preferredContactTime String? @map("preferred_contact_time")
  communicationStyle   String? @map("communication_style")

  // Relationships
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("student_preferences")
}

model Program {
  id                 String          @id @default(cuid())
  title              String
  categoryId         String          @map("category_id")
  description        String          @db.Text
  objectives         String[]
  coachId            String          @map("coach_id")
  slug               String          @unique
  rating             Float           @default(0)
  totalReviews       Int             @default(0) @map("total_reviews")
  price              Int             @default(0)
  duration           String?
  difficultyLevel    DifficultyLevel @default(BEGINNER) @map("difficulty_level")
  maxStudents        Int             @default(100) @map("max_students")
  currentEnrollments Int             @default(0) @map("current_enrollments")
  isActive           Boolean         @default(false) @map("is_active")
  status             ProgramStatus   @default(INACTIVE)
  tags               String[]
  prerequisites      String[]
  targetAudience     String?         @map("target_audience")
  createdAt          DateTime        @default(now()) @map("created_at")
  updatedAt          DateTime        @updatedAt @map("updated_at")

  // Relationships
  category    Category          @relation(fields: [categoryId], references: [id])
  coach       Coach             @relation(fields: [coachId], references: [id])
  modules     Module[]
  enrollments Enrollment[]
  cohorts     Cohort[]
  reviews     Review[]          @relation("ReviewProgram")
  coCoaches   ProgramCoach[]

  // Indexes for performance
  @@index([slug])
  @@index([categoryId])
  @@index([coachId])
  @@index([isActive, status])
  @@index([rating])
  @@index([difficultyLevel])
  @@index([createdAt])
  @@map("programs")
}

// Join table for co-coaches on programs
model ProgramCoach {
  id        String   @id @default(cuid())
  programId String   @map("program_id")
  coachId   String   @map("coach_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relationships
  program Program @relation(fields: [programId], references: [id], onDelete: Cascade)
  coach   Coach   @relation(fields: [coachId], references: [id], onDelete: Cascade)

  // Unique constraint to prevent duplicate coach assignments
  @@unique([programId, coachId])
  @@index([programId])
  @@index([coachId])
  @@map("program_coaches")
}

model Cohort {
  id          String       @id @default(cuid())
  programId   String       @map("program_id")
  name        String?      // e.g., "Spring 2024"
  startDate   DateTime     @map("start_date")
  endDate     DateTime?    @map("end_date")
  maxStudents Int          @default(100) @map("max_students")
  status      CohortStatus @default(UPCOMING)
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  program     Program      @relation(fields: [programId], references: [id], onDelete: Cascade)
  enrollments Enrollment[]

  @@index([programId])
  @@index([status])
  @@map("cohorts")
}

model Module {
  id          String   @id @default(cuid())
  programId   String   @map("program_id")
  title       String
  week        Int
  description String?  @db.Text
  materials   String[] @default([])

  // Relationships
  program Program @relation(fields: [programId], references: [id], onDelete: Cascade)

  // Indexes for performance
  @@index([programId])
  @@index([programId, week])
  @@map("modules")
}

model Enrollment {
  id             String           @id @default(cuid())
  studentId      String           @map("student_id")
  programId      String           @map("program_id")
  cohortId       String?          @map("cohort_id")
  coachId        String           @map("coach_id")
  status         EnrollmentStatus @default(ACTIVE)
  enrollmentDate DateTime         @default(now()) @map("enrollment_date")
  completionDate DateTime?        @map("completion_date")
  progress       Float            @default(0)
  paymentStatus  PaymentStatus    @default(PENDING) @map("payment_status")
  time           String
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")

  // Relationships
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  program Program @relation(fields: [programId], references: [id], onDelete: Cascade)
  cohort  Cohort? @relation(fields: [cohortId], references: [id])
  coach   Coach   @relation(fields: [coachId], references: [id])

  // Indexes for performance
  @@index([studentId])
  @@index([programId])
  @@index([cohortId])
  @@index([coachId])
  @@index([status])
  @@index([paymentStatus])
  @@index([studentId, status])
  @@index([coachId, status])
  @@index([enrollmentDate])
  @@map("enrollments")
}

model Session {
  id            String        @id @default(cuid())
  coachId       String        @map("coach_id")
  title         String?
  description   String?       @db.Text
  scheduledTime DateTime      @map("scheduled_time")
  duration      Int
  status        SessionStatus @default(SCHEDULED)
  meetLink      String?       @map("meet_link")
  googleEventId String?       @map("google_event_id")
  notes         String?       @db.Text
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  // Relationships
  coach      Coach               @relation(fields: [coachId], references: [id])
  attendance SessionAttendance[]
  recordings SessionRecording[]

  // Indexes for performance
  @@index([coachId])
  @@index([scheduledTime])
  @@index([status])
  @@index([coachId, scheduledTime])
  @@index([coachId, status])
  @@map("sessions")
}

model SessionAttendance {
  id                 String    @id @default(cuid())
  sessionId          String    @map("session_id")
  studentId          String    @map("student_id")
  joinTime           DateTime? @map("join_time")
  leaveTime          DateTime? @map("leave_time")
  attended           Boolean   @default(false)
  participationScore Int?      @map("participation_score")

  // Relationships
  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([sessionId, studentId])
  @@index([sessionId])
  @@index([studentId])
  @@index([studentId, attended])
  @@map("session_attendance")
}

model SessionRecording {
  id         String   @id @default(cuid())
  sessionId  String   @map("session_id")
  title      String
  url        String
  duration   Int
  uploadedAt DateTime @default(now()) @map("uploaded_at")
  isPublic   Boolean  @default(false) @map("is_public")

  // Relationships
  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Indexes for performance
  @@index([sessionId])
  @@index([uploadedAt])
  @@map("session_recordings")
}

model Review {
  id           String           @id @default(cuid())
  reviewerId   String           @map("reviewer_id")
  revieweeId   String?          @map("reviewee_id")
  programId    String?          @map("program_id")
  coachId      String?          @map("coach_id")
  targetType   ReviewTargetType @map("target_type")
  rating       Int
  title        String?
  content      String           @db.Text
  isVerified   Boolean          @default(false) @map("is_verified")
  isPublic     Boolean          @default(true) @map("is_public")
  helpfulCount Int              @default(0) @map("helpful_count")
  tags         String[]
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")

  // Relationships
  reviewer User     @relation("ReviewerUser", fields: [reviewerId], references: [id])
  reviewee User?    @relation("RevieweeUser", fields: [revieweeId], references: [id])
  program  Program? @relation("ReviewProgram", fields: [programId], references: [id])
  coach    Coach?   @relation("ReviewCoach", fields: [coachId], references: [id])

  // Indexes for performance
  @@index([reviewerId])
  @@index([revieweeId])
  @@index([programId])
  @@index([coachId])
  @@index([targetType])
  @@index([rating])
  @@index([isPublic, isVerified])
  @@index([createdAt])
  @@map("reviews")
}

model Conversation {
  id              String           @id @default(cuid())
  type            ConversationType @default(DIRECT)
  title           String?
  lastMessage     String?          @map("last_message")
  lastMessageTime DateTime?        @map("last_message_time")
  isActive        Boolean          @default(true) @map("is_active")
  isArchived      Boolean          @default(false) @map("is_archived")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  // Relationships
  participants ConversationParticipant[]
  messages     Message[]

  @@index([createdAt])
  @@index([lastMessageTime])
  @@index([type])
  @@map("conversations")
}

model ConversationParticipant {
  id             String @id @default(cuid())
  conversationId String @map("conversation_id")
  userId         String @map("user_id")
  unreadCount    Int    @default(0) @map("unread_count")

  // Relationships
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
  @@index([conversationId])
  @@map("conversation_participants")
}

model Message {
  id             String      @id @default(cuid())
  conversationId String      @map("conversation_id")
  senderId       String      @map("sender_id")
  content        String
  type           MessageType @default(TEXT)
  isRead         Boolean     @default(false) @map("is_read")
  readAt         DateTime?   @map("read_at")
  editedAt       DateTime?   @map("edited_at")
  isEdited       Boolean     @default(false) @map("is_edited")
  isDeleted      Boolean     @default(false) @map("is_deleted")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  // Relationships
  conversation Conversation        @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User                @relation(fields: [senderId], references: [id])
  attachments  MessageAttachment[]
  reactions    MessageReaction[]

  @@index([conversationId, createdAt])
  @@index([conversationId, isRead])
  @@index([senderId])
  @@map("messages")
}

model MessageAttachment {
  id         String   @id @default(cuid())
  messageId  String   @map("message_id")
  fileName   String   @map("file_name")
  fileUrl    String   @map("file_url")
  fileSize   Int      @map("file_size")
  mimeType   String   @map("mime_type")
  uploadedAt DateTime @default(now()) @map("uploaded_at")

  // Relationships
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@map("message_attachments")
}

model MessageReaction {
  id        String   @id @default(cuid())
  messageId String   @map("message_id")
  userId    String   @map("user_id")
  emoji     String
  createdAt DateTime @default(now()) @map("created_at")

  // Relationships
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@index([userId])
  @@map("message_reactions")
}

model Event {
  id             String   @id @default(cuid())
  title          String
  description    String   @db.Text
  eventType      String   @map("event_type")
  date           DateTime
  location       String?
  images         String[] // Array of image URLs
  slug           String   @unique
  organizerId    String   @map("organizer_id")
  isPublic       Boolean  @default(true) @map("is_public")
  maxAttendees   Int?     @map("max_attendees")
  status         String?
  tags           String[]
  meetLink       String?  @map("meet_link")
  googleEventId  String?  @map("google_event_id")
  whatToBring    String?  @map("what_to_bring") @db.Text
  additionalInfo String?  @map("additional_info") @db.Text
  lumaEventLink  String   @map("luma_event_link")
  accessType     String?  @map("access_type")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organizer User?           @relation("EventOrganizer", fields: [organizerId], references: [id])
  attendees EventAttendee[]

  // Indexes for performance
  @@index([slug])
  @@index([organizerId])
  @@index([date])
  @@index([eventType])
  @@index([isPublic, date])
  @@index([status])
  @@map("events")
}

model EventAttendee {
  id           String              @id @default(cuid())
  eventId      String              @map("event_id")
  studentId    String              @map("student_id")
  status       EventAttendeeStatus @default(REGISTERED)
  registeredAt DateTime            @default(now()) @map("registered_at")
  attendedAt   DateTime?           @map("attended_at")
  cancelledAt  DateTime?           @map("cancelled_at")
  notes        String?
  createdAt    DateTime            @default(now()) @map("created_at")
  updatedAt    DateTime            @updatedAt @map("updated_at")

  event   Event   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([eventId, studentId])
  @@index([eventId])
  @@index([studentId])
  @@index([status])
  @@map("event_attendees")
}
